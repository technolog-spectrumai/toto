{% extends "kodama/frame.html" %}
{% load theme_tags %}

{% block title %}{{ article.title }}{% endblock %}

{% block content %}
<div
  class="max-w-5xl mx-auto p-6"
>
  <!-- Title -->
  <h1
    class="text-3xl font-bold text-center mb-2"
    :class="darkMode
      ? '{{ theme|theme_class:"section_title:dark" }}'
      : '{{ theme|theme_class:"section_title:light" }}'">
    {{ article.title }}
  </h1>

  <!-- Header Image -->
  {% if article.image %}
    <div class="mb-6 text-center">
      <img
        src="{{ article.image.file }}"
        alt="Article image"
        class="max-w-3xl mx-auto rounded-md shadow"
        :class="darkMode
          ? '{{ theme|theme_class:"image_border:dark" }}'
          : '{{ theme|theme_class:"image_border:light" }}'">
      {% if article.image.title %}
        <p
          class="mt-2 text-sm italic text-center"
          :class="darkMode
            ? '{{ theme|theme_class:"image_caption:dark" }}'
            : '{{ theme|theme_class:"image_caption:light" }}'">
          {{ article.image.title }}
        </p>
      {% endif %}
    </div>
  {% endif %}

  <!-- Meta Info -->
  <p
    class="text-center text-sm mb-6"
    :class="darkMode
      ? '{{ theme|theme_class:"meta_text:dark" }}'
      : '{{ theme|theme_class:"meta_text:light" }}'">
    By
    <a
      href="{% url 'author_profile' site.slug article.author.username %}"
      class="font-semibold hover:underline"
      :class="darkMode
        ? '{{ theme|theme_class:"author_link:dark" }}'
        : '{{ theme|theme_class:"author_link:light" }}'">
      {{ article.author.username }}
    </a>
    |
    {{ article.created_at|date:"F j, Y" }}
    {% if article.version %}
      | Version: <span class="italic">{{ article.version }}</span>
    {% endif %}
  </p>

  <!-- Categories -->
  {% if article.categories.exists %}
    <div class="mb-6 text-sm text-center">
      {% for category in article.categories.all %}
        <span
          class="inline-block px-2 py-1 rounded-md"
          :class="darkMode
            ? '{{ theme|theme_class:"category_badge:dark" }}'
            : '{{ theme|theme_class:"category_badge:light" }}'">
          {{ category.name }}
        </span>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Abstract & Content -->
  <article class="mt-6">
    <div
      class="p-6 rounded-lg mb-6 markdown-content"
      :class="darkMode
        ? '{{ theme|theme_class:"abstract_box:dark" }}'
        : '{{ theme|theme_class:"abstract_box:light" }}'">
      <h2 class="text-xl font-semibold mb-3">Abstract</h2>
      <div>{{ article.abstract|safe }}</div>
    </div>

    <div
      class="p-6 rounded-lg markdown-content"
      :class="darkMode
        ? '{{ theme|theme_class:"content_box:dark" }}'
        : '{{ theme|theme_class:"content_box:light" }}'">
      <h2 class="text-xl font-semibold mb-3">Full Article:</h2>
      <div>
        {% for section in article.sections %}
          {% include "kodama/section.html" with section=section theme=theme %}
        {% empty %}
          <p class="italic text-center text-sm">No sections available for this article.</p>
        {% endfor %}
      </div>
    </div>

    <!-- Sources -->
    {% if article.sources.exists %}
      <div class="mt-8">
        <h3
          class="text-md font-semibold mb-2"
          :class="darkMode
            ? '{{ theme|theme_class:"section_title:dark" }}'
            : '{{ theme|theme_class:"section_title:light" }}'">
          Sources
        </h3>
        <ul
          class="list-disc list-inside text-sm"
          :class="darkMode
            ? '{{ theme|theme_class:"meta_text:dark" }}'
            : '{{ theme|theme_class:"meta_text:light" }}'">
          {% for source in article.sources.all %}
            <li>{{ source.name }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Word Count -->
    {% if user.is_authenticated %}
      <p
        class="text-sm text-right mt-6"
        :class="darkMode
          ? '{{ theme|theme_class:"meta_text:dark" }}'
          : '{{ theme|theme_class:"meta_text:light" }}'">
        Total words: {{ article.word_count }}
      </p>
    {% endif %}

    <!-- Reading Time -->
    <p
      class="text-sm text-right mt-2"
      :class="darkMode
        ? '{{ theme|theme_class:"meta_text:dark" }}'
        : '{{ theme|theme_class:"meta_text:light" }}'">
      {% if reader.minutes or reader.seconds %}
        ⏱ {{ reader.minutes|default:"0" }} min {{ reader.seconds|default:"0" }} sec to read
      {% else %}
        <em>Too short to measure</em>
      {% endif %}
    </p>
  </article>

  <!-- Tags -->
  {% if article.tags %}
    <div
      class="mt-6 text-sm flex flex-wrap justify-center gap-x-2 gap-y-1"
      :class="darkMode
        ? '{{ theme|theme_class:"tag_link:dark" }}'
        : '{{ theme|theme_class:"tag_link:light" }}'">
      {% for tag in article.tags.all %}
        <a
          href="{% url 'articles_by_tag' site.slug tag.slug %}"
          class="underline transition-colors"
          :class="darkMode
            ? 'hover:text-blue-300'
            : 'hover:text-blue-500'">
          #{{ tag.name }}
        </a>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Home Link -->
  <a
    href="{% url 'site_home' site.slug %}"
    class="block text-center mt-8 font-medium"
    :class="darkMode
      ? '{{ theme|theme_class:"home_link:dark" }}'
      : '{{ theme|theme_class:"home_link:light" }}'">
    ← Back to Articles
  </a>

  <!-- Feedback -->
  {% if user.is_authenticated %}
    <div class="flex justify-center mt-6 gap-6 text-2xl">
      <div class="flex flex-col items-center">
        <form method="post" action="{% url 'article_feedback' site.slug article.slug %}">
          {% csrf_token %}
          <input type="hidden" name="liked" value="true">
          <button
            type="submit"
            title="Like this article"
            :class="darkMode
              ? '{{ theme|theme_class:"like_button:dark" }}'
              : '{{ theme|theme_class:"like_button:light" }}'">
            <i class="fas fa-thumbs-up"></i>
          </button>
        </form>
        <span
          class="text-sm mt-1"
          :class="darkMode
            ? '{{ theme|theme_class:"like_count_text:dark" }}'
            : '{{ theme|theme_class:"like_count_text:light" }}'">
          {{ feedback.like_count }}
        </span>
      </div>

      <div class="flex flex-col items-center">
        <form method="post" action="{% url 'article_feedback' site.slug article.slug %}">
          {% csrf_token %}
          <input type="hidden" name="liked" value="false">
          <button
            type="submit"
            title="Dislike this article"
            :class="darkMode
              ? '{{ theme|theme_class:"dislike_button:dark" }}'
              : '{{ theme|theme_class:"dislike_button:light" }}'">
            <i class="fas fa-thumbs-down"></i>
          </button>
        </form>
        <span
          class="text-sm mt-1"
          :class="darkMode
            ? '{{ theme|theme_class:"dislike_count_text:dark" }}'
            : '{{ theme|theme_class:"dislike_count_text:light" }}'">
          {{ feedback.dislike_count }}
        </span>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
